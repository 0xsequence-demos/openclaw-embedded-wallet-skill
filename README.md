# openclaw-embedded-wallet-skill

A demo-quality (but real) OpenClaw skill + tooling for:
- linking a **Sequence Embedded Wallet (WaaS)** via email auth
- storing the session securely in **macOS Keychain**
- querying balances via **Sequence Indexer**
- sending **native** and **ERC20** transfers (with WaaS fee quotes)

This repo is designed to be run locally alongside OpenClaw.

## What’s in here

- `openclaw-skill/moltbot/` — the OpenClaw Skill (`SKILL.md`)
- `cli/sequence-waas/` — local CLI (`seq.mjs`) that:
  - creates wallet-link URLs
  - ingests encrypted session payloads
  - lists/removes wallet nicknames
  - shows address/balances
  - sends native + ERC20 transfers
- `worker-ui/` — Cloudflare Worker + Vite UI used to complete email auth and export the session to the CLI via sealed-box encryption

## Prerequisites

- macOS (for Keychain storage via `keytar`)
- Node.js 20+ (repo uses ESM)
- `pnpm`
- Cloudflare account + `wrangler` (to deploy the Worker UI)
- A Sequence project configured for Embedded Wallet:
  - Create a project at https://sequence.build
  - Enable Embedded Wallet (email auth)
  - Grab:
    - **Project Access Key**
    - **WaaS Config Key**

## 1) Deploy the wallet-link UI (Cloudflare Worker)

```bash
cd worker-ui
cp .env.example .env
# Fill in: VITE_PROJECT_ACCESS_KEY, VITE_WAAS_CONFIG_KEY
# Optional: VITE_POLYGON_INDEXER_ACCESS_KEY
pnpm install
pnpm build
wrangler deploy
```

After deploy, note your URL, e.g.:
`https://<your-worker>.workers.dev`

## 2) Configure the local CLI

```bash
cd cli/sequence-waas
npm install
cp .env.example .env
```

Fill in `.env`:
- `SEQUENCE_WAAS_PROJECT_ACCESS_KEY`
- `SEQUENCE_WAAS_CONFIG_KEY`
- `SEQUENCE_WAAS_WORKER_URL` (your worker URL from step 1)
- `SEQUENCE_INDEXER_ACCESS_KEY` (required for `balances`)

Then run commands as:

```bash
# load env vars
set -a; source .env; set +a

node seq.mjs --help
```

## 3) Link a wallet by nickname

### Create a link

```bash
node seq.mjs create-request --name demo-wallet --chain polygon
```

Open the returned URL, complete email auth, and copy the encrypted blob back.

### Ingest the session

```bash
node seq.mjs ingest-session --name demo-wallet --rid <rid> --ciphertext '<blob>'
```

This stores:
- `session:<name>`
- `sessionId:<name>`
- `wallet:<name>`

in macOS Keychain under service `openclaw.sequence-waas`.

## 4) List wallets / show address / balances

```bash
node seq.mjs wallets
node seq.mjs address --name demo-wallet
node seq.mjs balances --name demo-wallet --chain polygon
```

## 5) Send transactions

### Native transfer

Dry run:
```bash
node seq.mjs send-pol --name demo-wallet --to 0x... --amount 0.1 --chain polygon
```

Broadcast:
```bash
node seq.mjs send-pol --name demo-wallet --to 0x... --amount 0.1 --chain polygon --broadcast
```

### ERC20 transfer

```bash
node seq.mjs send-erc20 --name demo-wallet \
  --token 0x... \
  --to 0x... \
  --amount 1.5 \
  --decimals 6 \
  --chain polygon \
  --broadcast
```

### Fee token selection

By default the CLI will pick a reasonable fee token automatically.
If you explicitly want to pay fees with a given token symbol:

```bash
node seq.mjs send-pol --name demo-wallet --to 0x... --amount 0.1 --fee-token USDC --broadcast
```

## OpenClaw integration

Copy the skill folder into your OpenClaw workspace:

```bash
cp -R openclaw-skill/moltbot /path/to/.openclaw/workspace/skills/
```

The skill assumes the CLI lives at:
`/Users/taylan/.openclaw/workspace/tools/sequence-waas/seq.mjs`

If you’re not Taylan, adjust paths in the skill accordingly.

## Security notes

- No secrets should be committed.
- `.env` files are gitignored.
- Sessions are stored in macOS Keychain (not on disk).
- The worker encrypts the session payload to a one-time public key generated by the CLI.

## Troubleshooting

- If a new `/link?rid=...` fails due to an existing session, the UI will reset WaaS local state on new rid automatically.
- If transactions fail with “missing required fee payment”, ensure you include fee quote/option (the CLI does this automatically).
- If balances fail, ensure `SEQUENCE_INDEXER_ACCESS_KEY` is set.
